name: Build and Release

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Get version
        id: version
        run: |
          VERSION_NAME=$(grep versionName app/build.gradle.kts | cut -d'"' -f2)
          VERSION_CODE=$(grep versionCode app/build.gradle.kts | cut -d'=' -f2 | tr -d ' ')
          echo "name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION_NAME-$VERSION_CODE" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.name }}
          body: |
            ## ⚠️ WARNING: Vibe-Coded Software
            
            This app is vibe-coded and not intended for production use.
            
            **Version:** ${{ steps.version.outputs.name }} (build ${{ steps.version.outputs.code }})
            **Minimum Android:** 10 (API 29)
            **Target Android:** 14 (API 34)
          files: app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
